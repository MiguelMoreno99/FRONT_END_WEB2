<!-- src/app/equipos/equipos.component.html -->
<div class="titulo-shonen">
  <h1>Equipos</h1>
</div>

<div
  class="container mt-3"
  style="position: fixed; z-index: 1050; top: 20px; right: 20px; width: auto"
>
  @if (mensajeExito) {
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    {{ mensajeExito }}
    <button
      type="button"
      class="btn-close"
      (click)="mensajeExito = ''"
    ></button>
  </div>
  } @if (mensajeError) {
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    {{ mensajeError }}
    <button
      type="button"
      class="btn-close"
      (click)="mensajeError = ''"
    ></button>
  </div>
  }
</div>
<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <section class="top-products">
        <div class="container-options">
          <span
            [class.active]="filtroActual === 'todos'"
            (click)="cambiarFiltro('todos')"
          >
            Todos
          </span>
          @if (userId) {
          <span
            [class.active]="filtroActual === 'favoritos'"
            (click)="cambiarFiltro('favoritos')"
          >
            Favoritos
          </span>
          }
        </div>
        <div class="container-products">
          <div class="card-product" *ngFor="let e of equiposFiltrados">
            <div
              class="container-img"
              [style.background-image]="
                'linear-gradient(rgba(0,0,0,0.35), rgba(0,0,0,0.35)), url(' +
                (e.bandera || 'assets/img/equipos/default.jpg') +
                ')'
              "
            >
              <div class="button-group">
                <span>
                  <a (click)="abrirModal(e)" style="cursor: pointer">
                    <i class="fa-regular fa-eye"></i>
                  </a>
                </span>
                @if (userId) {
                <span (click)="toggleFavorito(e.id)" style="cursor: pointer">
                  <i
                    [class]="
                      esFavorito(e.id)
                        ? 'fa-solid fa-heart'
                        : 'fa-regular fa-heart'
                    "
                    [class.heart-active]="esFavorito(e.id)"
                  >
                  </i>
                </span>
                } @if (userToken) {
                <span>
                  <a (click)="abrirModalEdicion(e)" style="cursor: pointer">
                    <i class="fa-solid fa-pencil"></i>
                  </a>
                </span>
                <span
                  (click)="eliminarEquipo(e, $event)"
                  class="btn-delete"
                  style="cursor: pointer"
                  title="Eliminar Equipo"
                >
                  <i class="fa-regular fa-trash-can"></i>
                </span>
                }
              </div>
            </div>

            <div class="content-card-product">
              <h3 style="color: white">{{ e.nombre }}</h3>

              <div class="equipo-info">
                <p style="color: white; margin: 0.8rem 0; font-size: 1rem">
                  <strong style="color: goldenrod; margin-right: 0.5rem"
                    >País:</strong
                  >
                  <span>{{ e.nombreCompletoPais }}</span>
                </p>
                <p style="color: white; margin: 0.8rem 0; font-size: 1rem">
                  <strong style="color: goldenrod; margin-right: 0.5rem"
                    >Siglas:</strong
                  >
                  <span
                    style="
                      color: goldenrod;
                      font-weight: bold;
                      background: rgba(218, 165, 32, 0.2);
                      padding: 0.2rem 0.6rem;
                      border-radius: 4px;
                    "
                  >
                    {{ e.siglasEquipo }}
                  </span>
                </p>
                <p style="color: white; margin: 0.8rem 0; font-size: 1rem">
                  <strong style="color: goldenrod; margin-right: 0.5rem"
                    >Grupo:</strong
                  >
                  <span
                    style="
                      color: #4caf50;
                      font-weight: bold;
                      background: rgba(76, 175, 80, 0.2);
                      padding: 0.2rem 0.6rem;
                      border-radius: 4px;
                    "
                  >
                    {{ e.grupo }}
                  </span>
                </p>
                <p style="color: white; margin: 0.8rem 0; font-size: 1rem">
                  <strong style="color: goldenrod; margin-right: 0.5rem"
                    >Ranking FIFA:</strong
                  >
                  <span
                    style="
                      color: #2196f3;
                      font-weight: bold;
                      background: rgba(33, 150, 243, 0.2);
                      padding: 0.2rem 0.6rem;
                      border-radius: 4px;
                    "
                  >
                    #{{ e.rankingFifa }}
                  </span>
                </p>
              </div>
            </div>
          </div>
          @if (filtroActual === 'favoritos' && equiposFiltrados.length === 0) {
          <div
            class="text-center w-100"
            style="grid-column: 1/-1; color: white; text-align: center"
          >
            <h3>
              No tienes equipos favoritos aún
              <i class="fa-regular fa-face-sad-tear"></i>
            </h3>
          </div>
          }
        </div>
      </section>
    </div>
  </div>
</div>

<!-- Modal básico -->
<div class="modal-overlay" *ngIf="mostrarModal" (click)="cerrarModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ equipoSeleccionado?.nombre }}</h2>
      <button class="close-button" (click)="cerrarModal()">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>

    <div class="modal-body" *ngIf="equipoSeleccionado">
      <div class="info-grid">
        <div class="info-item">
          <span class="info-label">País completo</span>
          <div class="info-value">
            <span class="pais-info">{{
              equipoSeleccionado.nombreCompletoPais
            }}</span>
          </div>
        </div>

        <div class="info-item">
          <span class="info-label">Siglas</span>
          <div class="info-value">
            <span class="siglas-badge">{{
              equipoSeleccionado.siglasEquipo
            }}</span>
          </div>
        </div>

        <div class="info-item">
          <span class="info-label">Grupo</span>
          <div class="info-value">
            <span class="grupo-badge">{{ equipoSeleccionado.grupo }}</span>
          </div>
        </div>

        <div class="info-item">
          <span class="info-label">Ranking FIFA</span>
          <div class="info-value">
            <span class="ranking-badge"
              >#{{ equipoSeleccionado.rankingFifa }}</span
            >
          </div>
        </div>
      </div>

      <div *ngIf="equipoSeleccionado.informacion">
        <h4>Información</h4>
        <div class="informacion-equipo">
          {{ equipoSeleccionado.informacion }}
        </div>
      </div>

      <div
        *ngIf="
          equipoSeleccionado.jugadores &&
          equipoSeleccionado.jugadores.length > 0
        "
      >
        <h4>Jugadores</h4>
        <div class="jugadores-list">
          <div
            *ngFor="let jugador of equipoSeleccionado.jugadores"
            class="jugador-item"
          >
            #{{ jugador.numeroCamiseta }} - {{ jugador.nombre }}
            {{ jugador.apellido }} ({{ jugador.posicion }})
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- Modal de edición -->
<div
  class="modal-overlay"
  *ngIf="mostrarModalEdicion"
  (click)="cerrarModalEdicion()"
>
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>
        <i class="fa-solid fa-pen-to-square"></i>
        Editar Equipo: {{ equipoEditado?.nombre }}
      </h2>
      <button class="close-button" (click)="cerrarModalEdicion()">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <!-- Mensajes -->
      <div class="mensaje-exito" *ngIf="mensajeExito">
        <i class="fa-solid fa-circle-check"></i> {{ mensajeExito }}
      </div>
      <div class="mensaje-error" *ngIf="mensajeError">
        <i class="fa-solid fa-circle-exclamation"></i> {{ mensajeError }}
      </div>

      <!-- Formulario principal -->
      <div [formGroup]="equipoEditForm">
        <!--  MOVER formGroup AQUÍ -->

        <div class="form-grid">
          <!-- Nombre -->
          <div class="form-group">
            <label for="nombre">
              <i class="fa-solid fa-signature"></i> Nombre *
            </label>
            <input
              type="text"
              id="nombre"
              formControlName="nombre"
              class="form-input"
              placeholder="Ej: Argentina"
              [class.is-invalid]="tieneError('nombre')"
            />
            @if (tieneError('nombre')) {
            <div class="error-message">{{ getMensajeError("nombre") }}</div>
            }
          </div>

          <!-- País completo -->
          <div class="form-group">
            <label for="nombreCompletoPais">
              <i class="fa-solid fa-earth-americas"></i> País Completo *
            </label>
            <input
              type="text"
              id="nombreCompletoPais"
              formControlName="nombreCompletoPais"
              class="form-input"
              placeholder="Ej: República Argentina"
              [class.is-invalid]="tieneError('nombreCompletoPais')"
            />
            @if (tieneError('nombreCompletoPais')) {
            <div class="error-message">
              {{ getMensajeError("nombreCompletoPais") }}
            </div>
            }
          </div>

          <!-- Grupo -->
          <div class="form-group">
            <label for="grupo">
              <i class="fa-solid fa-layer-group"></i> Grupo *
            </label>
            <select
              id="grupo"
              formControlName="grupo"
              class="form-select"
              [class.is-invalid]="tieneError('grupo')"
            >
              <option value="">-- Seleccionar grupo --</option>
              <option *ngFor="let grupo of ordenarGrupos()" [value]="grupo">
                {{ grupo }}
              </option>
            </select>
            @if (tieneError('grupo')) {
            <div class="error-message">{{ getMensajeError("grupo") }}</div>
            }
          </div>

          <!-- Ranking FIFA -->
          <div class="form-group">
            <label for="rankingFifa">
              <i class="fa-solid fa-ranking-star"></i> Ranking FIFA *
            </label>
            <input
              type="number"
              id="rankingFifa"
              formControlName="rankingFifa"
              min="1"
              max="211"
              class="form-input"
              placeholder="1"
              [class.is-invalid]="tieneError('rankingFifa')"
            />
            @if (tieneError('rankingFifa')) {
            <div class="error-message">
              {{ getMensajeError("rankingFifa") }}
            </div>
            }
          </div>

          <!-- Bandera -->
          <div class="form-group">
            <label for="bandera">
              <i class="fa-solid fa-image"></i> URL de la Bandera
            </label>
            <input
              type="text"
              id="bandera"
              formControlName="bandera"
              class="form-input"
              placeholder="assets/img/equipos/argentina.jpg"
              [class.is-invalid]="tieneError('bandera')"
            />
            @if (tieneError('bandera')) {
            <div class="error-message">{{ getMensajeError("bandera") }}</div>
            }
          </div>

          <!-- Información -->
          <div class="form-group full-width">
            <label for="informacion">
              <i class="fa-solid fa-circle-info"></i> Información
            </label>
            <textarea
              id="informacion"
              formControlName="informacion"
              rows="4"
              class="form-textarea"
              placeholder="Información sobre el equipo..."
              [class.is-invalid]="tieneError('informacion')"
            ></textarea>
            @if (tieneError('informacion')) {
            <div class="error-message">
              {{ getMensajeError("informacion") }}
            </div>
            }
          </div>
        </div>

        <!-- Jugadores -->
        <div class="seccion-jugadores">
          <h3>
            <i class="fa-solid fa-users"></i> Jugadores
            <button
              type="button"
              class="btn-agregar"
              (click)="mostrarFormularioNuevoJugador()"
            >
              <i class="fa-solid fa-plus"></i> Agregar Jugador
            </button>
          </h3>

          <div class="formulario-nuevo-jugador" *ngIf="agregandoJugador">
            <h4>Nuevo Jugador</h4>
            <div class="form-grid-jugador" [formGroup]="nuevoJugadorForm">
              <div class="form-group">
                <label>Nombre *</label>
                <input
                  type="text"
                  formControlName="nombre"
                  class="form-input"
                  placeholder="Lionel"
                  [class.is-invalid]="tieneErrorNuevoJugador('nombre')"
                />
                @if (tieneErrorNuevoJugador('nombre')) {
                <div class="error-message">
                  {{ getMensajeErrorNuevoJugador("nombre") }}
                </div>
                }
              </div>
              <div class="form-group">
                <label>Apellido *</label>
                <input
                  type="text"
                  formControlName="apellido"
                  class="form-input"
                  placeholder="Messi"
                  [class.is-invalid]="tieneErrorNuevoJugador('apellido')"
                />
                @if (tieneErrorNuevoJugador('apellido')) {
                <div class="error-message">
                  {{ getMensajeErrorNuevoJugador("apellido") }}
                </div>
                }
              </div>
              <div class="form-group">
                <label>Posición *</label>
                <select
                  formControlName="posicion"
                  class="form-select"
                  [class.is-invalid]="tieneErrorNuevoJugador('posicion')"
                >
                  <option value="">-- Seleccionar posición --</option>
                  <option
                    *ngFor="let posicion of ordenarPosiciones()"
                    [value]="posicion"
                  >
                    {{ posicion }}
                  </option>
                </select>
                @if (tieneErrorNuevoJugador('posicion')) {
                <div class="error-message">
                  {{ getMensajeErrorNuevoJugador("posicion") }}
                </div>
                }
              </div>
              <div class="form-group">
                <label>Número *</label>
                <input
                  type="number"
                  formControlName="numeroCamiseta"
                  min="1"
                  max="99"
                  class="form-input"
                  placeholder="10"
                  [class.is-invalid]="tieneErrorNuevoJugador('numeroCamiseta')"
                />
                @if (tieneErrorNuevoJugador('numeroCamiseta')) {
                <div class="error-message">
                  {{ getMensajeErrorNuevoJugador("numeroCamiseta") }}
                </div>
                }
              </div>
              <div class="form-group">
                <label>Fecha Nacimiento *</label>
                <input
                  type="date"
                  formControlName="fechaNacimiento"
                  class="form-input"
                  [class.is-invalid]="tieneErrorNuevoJugador('fechaNacimiento')"
                />
                @if (tieneErrorNuevoJugador('fechaNacimiento')) {
                <div class="error-message">
                  {{ getMensajeErrorNuevoJugador("fechaNacimiento") }}
                </div>
                }
              </div>
              <div class="form-group acciones">
                <button
                  type="button"
                  class="btn-guardar-jugador"
                  (click)="agregarNuevoJugador()"
                  [disabled]="nuevoJugadorForm.invalid"
                >
                  <i class="fa-solid fa-save"></i> Guardar
                </button>
                <button
                  type="button"
                  class="btn-cancelar"
                  (click)="cancelarAgregarJugador()"
                >
                  <i class="fa-solid fa-times"></i> Cancelar
                </button>
              </div>
            </div>
          </div>

          <!-- Lista de jugadores existentes (dentro del formGroup principal) -->
          <div formArrayName="jugadores">
            @for (jugador of jugadoresArray.controls; track jugador; let i =
            $index) {
            <div [formGroupName]="i" class="jugador-item-editable">
              <div class="jugador-info">
                <span class="jugador-numero">
                  #{{ jugador.get("numeroCamiseta")?.value || "?" }}
                </span>
                <div class="jugador-datos">
                  <div class="jugador-nombre">
                    {{ jugador.get("nombre")?.value }}
                    {{ jugador.get("apellido")?.value }}
                  </div>
                  <div class="jugador-detalle">
                    <span class="posicion-badge">{{
                      jugador.get("posicion")?.value
                    }}</span>
                  </div>
                  @if (jugador.get('fechaNacimiento')?.value) {
                  <div class="jugador-detalle">
                    {{
                      jugador.get("fechaNacimiento")?.value
                        | date : "dd/MM/yyyy"
                    }}
                  </div>
                  }
                </div>
              </div>
              <button
                type="button"
                class="btn-eliminar"
                (click)="eliminarJugadorFormulario(i)"
                title="Eliminar jugador"
              >
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
            }
          </div>

          @if (jugadoresArray.length === 0) {
          <div class="sin-jugadores">
            <i class="fa-solid fa-user-slash"></i>
            <p>No hay jugadores registrados</p>
          </div>
          }
        </div>

        <!-- Botones de acción -->
        <div class="modal-actions">
          <button
            type="button"
            class="btn-cancelar"
            (click)="cerrarModalEdicion()"
          >
            <i class="fa-solid fa-times"></i> Cancelar
          </button>
          <button
            type="button"
            class="btn-guardar"
            (click)="guardarCambios()"
            [disabled]="guardando"
          >
            @if (guardando) {
            <i class="fa-solid fa-spinner fa-spin"></i> Guardando... } @else {
            <i class="fa-solid fa-save"></i> Guardar Cambios }
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
