<div class="titulo-shonen">
  <h1>Partidos</h1>
</div>

<div
  class="container mt-3"
  style="position: fixed; z-index: 1050; top: 20px; right: 20px; width: auto"
>
  @if (mensajeExito) {
  <div class="alert alert-success alert-dismissible fade show" role="alert">
    {{ mensajeExito }}
    <button
      type="button"
      class="btn-close"
      (click)="mensajeExito = ''"
    ></button>
  </div>
  } @if (mensajeError) {
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
    {{ mensajeError }}
    <button
      type="button"
      class="btn-close"
      (click)="mensajeError = ''"
    ></button>
  </div>
  }
</div>

<div class="container-fluid">
  <div class="row">
    <div class="col-12">
      <section class="top-products">
        <div class="container-options">
          <span
            [class.active]="filtroActual === 'todos'"
            (click)="cambiarFiltro('todos')"
          >
            Todos
          </span>
          <span
            [class.active]="filtroActual === 'en_vivo'"
            (click)="cambiarFiltro('en_vivo')"
          >
            En Vivo
          </span>
          @if (userId) {
          <span
            [class.active]="filtroActual === 'favoritos'"
            (click)="cambiarFiltro('favoritos')"
          >
            Favoritos
          </span>
          }
        </div>
        <div class="container-products">
          <div class="card-product" *ngFor="let p of partidosFiltrados">
            <div style="display: none">{{ p.stadiumImage }}</div>
            <div
              class="container-img"
              [ngStyle]="{
                'background-image':
                  'linear-gradient(rgba(0,0,0,0.35), rgba(0,0,0,0.35)), url(' +
                  p.stadiumImage +
                  ')'
              }"
            >
              <div class="button-group">
                <span>
                  <a (click)="abrirModal(p)" style="cursor: pointer"
                    ><i class="fa-regular fa-eye"></i
                  ></a>
                </span>
                @if (userId) {
                <span (click)="toggleFavorito(p.id)" class="btn-heart">
                  <i
                    [class]="
                      esFavorito(p.id)
                        ? 'fa-solid fa-heart'
                        : 'fa-regular fa-heart'
                    "
                    [class.heart-active]="esFavorito(p.id)"
                  >
                  </i>
                </span>
                } @if (userToken) {
                <span (click)="abrirModalEdicion(p)" class="btn-edit">
                  <i class="fa-regular fa-edit"></i>
                </span>
                <span
                  (click)="eliminarPartido(p, $event)"
                  class="btn-delete"
                  title="Eliminar"
                >
                  <i class="fa-regular fa-trash-can"></i>
                </span>
                }
              </div>
            </div>
            <div class="content-card-product">
              <div class="equipos">
                <div class="equipo">
                  <div class="nombre">{{ p.equipoA.nombre }}</div>
                  <div class="goles">{{ p.golesEquipoA }}</div>
                </div>
                <div class="versus">vs</div>
                <div class="equipo">
                  <div class="nombre">{{ p.equipoB.nombre }}</div>
                  <div class="goles">{{ p.golesEquipoB }}</div>
                </div>
              </div>

              <div class="detalles">
                <span class="fecha">{{
                  p.fecha | date : "medium" : "UTC"
                }}</span>
                <span class="estadio">{{ p.estadio || p.ciudad }}</span>
              </div>
            </div>
          </div>
          @if (filtroActual === 'favoritos' && partidosFiltrados.length === 0){
          <div
            class="text-center w-100"
            style="grid-column: 1/-1; color: white"
          >
            <h3>
              No tienes partidos favoritos aún
              <i class="fa-regular fa-face-sad-tear"></i>
            </h3>
          </div>
          } @if (filtroActual === 'en_vivo' && partidosFiltrados.length === 0){
          <div
            class="text-center w-100"
            style="grid-column: 1/-1; color: white"
          >
            <h3>
              No hay partidos en juego en este momento
              <i class="fa-regular fa-futbol"></i>
            </h3>
          </div>
          }
        </div>
      </section>
    </div>
  </div>
</div>
<!-- Modal para detalles del partido -->
@if (mostrarModal) {
<div class="modal-overlay" (click)="cerrarModal()">
  <div class="modal-content" (click)="prevenirCierre($event)">
    <div class="modal-header">
      <h2>Detalles del Partido</h2>
      <button class="close-button" (click)="cerrarModal()">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>
    @if (partidoSeleccionado) {
    <div class="modal-body">
      <!-- Encabezado con equipos y resultado -->
      <div class="modal-equipos">
        <div class="modal-equipo">
          <div class="modal-equipo-nombre">
            {{ partidoSeleccionado.equipoA.nombre }}
          </div>
          <div class="modal-goles">{{ partidoSeleccionado.golesEquipoA }}</div>
        </div>
        <div class="modal-vs">VS</div>
        <div class="modal-equipo">
          <div class="modal-equipo-nombre">
            {{ partidoSeleccionado.equipoB.nombre }}
          </div>
          <div class="modal-goles">{{ partidoSeleccionado.golesEquipoB }}</div>
        </div>
      </div>

      <!-- Información detallada -->
      <div class="modal-info-grid">
        <div class="info-item">
          <span class="info-label"
            ><i class="fa-solid fa-calendar"></i> Fecha:</span
          >
          <span class="info-value">{{
            partidoSeleccionado.fecha | date : "fullDate" : "UTC"
          }}</span>
        </div>
        <div class="info-item">
          <span class="info-label"
            ><i class="fa-solid fa-clock"></i> Hora:</span
          >
          <span class="info-value">{{
            partidoSeleccionado.fecha | date : "shortTime" : "UTC"
          }}</span>
        </div>
        <div class="info-item">
          <span class="info-label"
            ><i class="fa-solid fa-location-dot"></i> Estadio:</span
          >
          <span class="info-value">{{ partidoSeleccionado.estadio }}</span>
        </div>
        <div class="info-item">
          <span class="info-label"
            ><i class="fa-solid fa-city"></i> Ciudad:</span
          >
          <span class="info-value">{{ partidoSeleccionado.ciudad }}</span>
        </div>
        <div class="info-item">
          <span class="info-label"
            ><i class="fa-solid fa-diagram-project"></i> Fase:</span
          >
          <span class="info-value">{{ partidoSeleccionado.fase }}</span>
        </div>
        <div class="info-item">
          <span class="info-label"
            ><i class="fa-solid fa-people-group"></i> Grupo:</span
          >
          <span class="info-value">{{ partidoSeleccionado.grupo }}</span>
        </div>
        <div class="info-item">
          <span class="info-label"
            ><i class="fa-solid fa-whistle"></i> Árbitro:</span
          >
          <span class="info-value">{{
            partidoSeleccionado.arbitroPrincipal
          }}</span>
        </div>
        <div class="info-item">
          <span class="info-label"
            ><i class="fa-solid fa-flag"></i> Estado:</span
          >
          <span class="info-value">{{ partidoSeleccionado.estado }}</span>
        </div>
      </div>

      <!-- Información de equipos -->
      <div class="equipos-detalle">
        <div class="equipo-detalle">
          <h4>{{ partidoSeleccionado.equipoA.nombre }}</h4>
          <p>
            <strong>País:</strong>
            {{ partidoSeleccionado.equipoA.nombreCompletoPais }}
          </p>
          <p>
            <strong>Ranking FIFA:</strong>
            {{ partidoSeleccionado.equipoA.rankingFifa || "N/A" }}
          </p>
        </div>
        <div class="equipo-detalle">
          <h4>{{ partidoSeleccionado.equipoB.nombre }}</h4>
          <p>
            <strong>País:</strong>
            {{ partidoSeleccionado.equipoB.nombreCompletoPais }}
          </p>
          <p>
            <strong>Ranking FIFA:</strong>
            {{ partidoSeleccionado.equipoB.rankingFifa || "N/A" }}
          </p>
        </div>
      </div>
    </div>
    }
  </div>
</div>
}
<!-- Modal para edición del partido -->
@if (mostrarModalEdicion) {
<div class="modal-overlay modal-edicion" (click)="cerrarModalEdicion()">
  <div
    class="modal-content modal-edicion-content"
    (click)="prevenirCierre($event)"
    [formGroup]="formularioEdicion"
  >
    <div class="modal-header">
      <h2>
        <i class="fa-regular fa-edit" style="margin-right: 10px"></i>
        Editar Partido
      </h2>
      <button class="close-button" (click)="cerrarModalEdicion()">
        <i class="fa-solid fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <!-- Información de equipos (solo lectura) -->
      <div class="marcador-visualizacion" style="margin-bottom: 2rem">
        <div class="marcador-header">
          <h3 style="color: goldenrod; text-align: center; margin-bottom: 20px">
            <i class="fa-solid fa-scoreboard me-2"></i> Marcador
          </h3>
        </div>

        <div class="marcador-equipos">
          <!-- Equipo A -->
          <div class="equipo-info">
            <div class="equipo-nombre">
              <h4 style="color: #4caf50">
                {{ partidoEditando?.equipoA?.nombre }}
              </h4>
            </div>
            <div class="equipo-goles">
              <div class="goles-display">
                <span class="goles-numero">
                  {{ partidoEditando?.golesEquipoA || 0 }}
                </span>
              </div>
              <button
                class="btn-gol"
                (click)="abrirRegistroGol('A')"
                title="Anotar Gol Equipo A"
              >
                <i class="fa-solid fa-futbol"></i> +
              </button>
            </div>
          </div>

          <!-- Separador -->
          <div class="marcador-separador">
            <span style="color: goldenrod; font-size: 2rem; font-weight: bold"
              >VS</span
            >
          </div>

          <!-- Equipo B -->
          <div class="equipo-info">
            <div class="equipo-nombre">
              <h4 style="color: #2196f3">
                {{ partidoEditando?.equipoB?.nombre }}
              </h4>
            </div>
            <div class="equipo-goles">
              <div class="goles-display">
                <span class="goles-numero">
                  {{ partidoEditando?.golesEquipoB || 0 }}
                </span>
              </div>
              <button
                class="btn-gol"
                (click)="abrirRegistroGol('B')"
                title="Anotar Gol Equipo B"
              >
                <i class="fa-solid fa-futbol"></i> +
              </button>
            </div>
          </div>
        </div>

        @if (mostrarInputGol) {
        <div class="gol-input-overlay">
          <div class="gol-input-box">
            <h4>
              ¡Gol de
              {{
                equipoAnotador === "A"
                  ? partidoEditando?.equipoA?.nombre
                  : partidoEditando?.equipoB?.nombre
              }}!
            </h4>
            <p>Ingresa el nombre del jugador o comentario:</p>
            <input
              type="text"
              placeholder="Ej: Messi de tiro libre"
              class="form-input"
              autofocus
            />
            <div class="gol-actions">
              <button class="btn-cancelar-sm" (click)="cancelarGol()">
                Cancelar
              </button>
              <button class="btn-aceptar-sm" (click)="confirmarGol()">
                Aceptar
              </button>
            </div>
          </div>
        </div>
        }

        <div class="formulario-edicion">
          <div class="form-grid">
            <div class="form-group">
              <label for="fecha">
                <i class="fa-solid fa-calendar"></i> Fecha
              </label>
              <input
                type="date"
                id="fecha"
                formControlName="fecha"
                class="form-input"
                [class.is-invalid]="
                  formularioEdicion.get('fecha')?.invalid &&
                  formularioEdicion.get('fecha')?.touched
                "
              />
              @if(formularioEdicion.get('fecha')?.hasError('required')) {
              <label>
                <i class="fa-solid fa-exclamation-circle"></i>La fecha es
                requerida.
              </label>
              } @if(formularioEdicion.get('fecha')?.hasError('fechaAnterior')) {
              <label>
                <i class="fa-solid fa-exclamation-circle"></i> La fecha del
                partido debe ser mayor o igual a la fecha actual.
              </label>
              }
            </div>

            <!-- Hora -->
            <div class="form-group">
              <label for="HoraPartido">
                <i class="fa-solid fa-clock"></i> Hora
              </label>
              <input
                type="time"
                id="hora"
                formControlName="hora"
                class="form-input"
                [class.is-invalid]="
                  formularioEdicion.get('hora')?.invalid &&
                  formularioEdicion.get('hora')?.touched
                "
              />
              @if(formularioEdicion.get('hora')?.hasError('required')) {
              <label>
                <i class="fa-solid fa-exclamation-circle"></i> La hora del
                partido es obligatoria.
              </label>
              }@else if(formularioEdicion.get('hora')?.hasError('horaFutura')) {
              <label>
                <i class="fa-solid fa-exclamation-circle"></i> La hora del
                partido debe ser mayor a la hora actual.
              </label>
              }
            </div>

            <div class="form-group">
              <label for="estadio">
                <i class="fa-solid fa-location-dot"></i> Estadio
              </label>
              <input
                type="text"
                id="estadio"
                formControlName="estadio"
                class="form-input"
                placeholder="Nombre del estadio"
                [class.is-invalid]="
                  formularioEdicion.get('estadio')?.invalid &&
                  formularioEdicion.get('estadio')?.touched
                "
              />
              @if (formularioEdicion.get('estadio')?.hasError('required')) {
              <label>
                <i class="fa-solid fa-exclamation-circle"></i> El estadio es
                requerido.
              </label>
              }
            </div>

            <div class="form-group">
              <label for="ciudad">
                <i class="fa-solid fa-city"></i> Ciudad
              </label>
              <input
                type="text"
                id="ciudad"
                formControlName="ciudad"
                class="form-input"
                placeholder="Ciudad"
                [class.is-invalid]="
                  formularioEdicion.get('ciudad')?.invalid &&
                  formularioEdicion.get('ciudad')?.touched
                "
              />
              @if (formularioEdicion.get('ciudad')?.hasError('required')){
              <label>
                <i class="fa-solid fa-exclamation-circle"></i> La ciudad es
                requerida.
              </label>
              }
            </div>

            <div class="form-group">
              <label for="arbitro">
                <i class="fa-solid fa-whistle"></i> Árbitro Principal
              </label>
              <input
                type="text"
                id="arbitroPrincipal"
                formControlName="arbitroPrincipal"
                class="form-input"
                placeholder="Nombre del árbitro"
                [class.is-invalid]="
                  formularioEdicion.get('arbitroPrincipal')?.invalid &&
                  formularioEdicion.get('arbitroPrincipal')?.touched
                "
              />
              @if
              (formularioEdicion.get('arbitroPrincipal')?.hasError('pattern')){
              <label>
                <i class="fa-solid fa-exclamation-circle"></i> Ingrese un nombre
                válido
              </label>
              }
            </div>

            <div class="form-group full-width">
              <label for="estado">
                <i class="fa-solid fa-flag"></i> Estado del Partido
              </label>
              <div class="estado-options">
                <label *ngFor="let estado of estados" class="estado-option">
                  <input
                    type="radio"
                    formControlName="estado"
                    [value]="estado"
                    [attr.disabled]="true"
                  />
                  <span
                    class="estado-badge"
                    [class.selected]="
                      formularioEdicion.get('estado')?.value === estado
                    "
                  >
                    {{ estado }}
                  </span>
                </label>
              </div>
            </div>
          </div>

          <div class="modal-actions-container">
            <div class="estado-actions">
              @if (partidoEditando?.estado === 'PROGRAMADO') {
              <button
                type="button"
                class="btn-iniciar"
                (click)="iniciarPartido()"
              >
                <i class="fa-solid fa-play"></i> Iniciar Partido
              </button>
              } @if (partidoEditando?.estado === 'EN_JUEGO') {
              <button
                type="button"
                class="btn-finalizar"
                (click)="finalizarPartido()"
              >
                <i class="fa-solid fa-flag-checkered"></i> Finalizar Partido
              </button>
              }
            </div>

            <div class="save-actions">
              <button
                type="button"
                class="btn-cancelar"
                (click)="cerrarModalEdicion()"
              >
                <i class="fa-solid fa-times"></i> Cancelar
              </button>
              <button
                type="button"
                class="btn-guardar"
                (click)="guardarCambios()"
                [disabled]="formularioEdicion.invalid"
              >
                <i class="fa-solid fa-save"></i> Guardar Cambios
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
}
